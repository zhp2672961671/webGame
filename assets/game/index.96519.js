window.__require=function t(e,i,a){function n(r,s){if(!i[r]){if(!e[r]){var c=r.split("/");if(c=c[c.length-1],!e[c]){var l="function"==typeof __require&&__require;if(!s&&l)return l(c,!0);if(o)return o(c,!0);throw new Error("Cannot find module '"+r+"'")}r=c}var h=i[r]={exports:{}};e[r][0].call(h.exports,function(t){return n(e[r][1][t]||t)},h,h.exports,t,e,i,a)}return i[r].exports}for(var o="function"==typeof __require&&__require,r=0;r<a.length;r++)n(a[r]);return n}({Comm:[function(t,e){"use strict";cc._RF.push(e,"1d260IA5QhB5Lx5Sb8wIrja","Comm");var i=t("./prefab/TipPrefab.js"),a=t("./prefab/ConfirmDialogPrefab.js");e.exports={gridWidth:7,gridHeight:6,HeroNum:4,calcClearScore:function(t){return t*t*5},calcLastScore:function(t){return Math.max(0,2e3-t*t*20)},tip:function(t){console.log("tip"),cc.loader.loadRes("prefab/TipPrefab",function(e,a){if(e)console.log(e);else{var n=cc.instantiate(a);cc.director.getScene().addChild(n),n.getComponent(i).show(t)}})},confirm:function(t,e,i,n,o,r){console.log("confirm"),cc.loader.loadRes("prefab/ConfirmDialogPrefab",function(s,c){if(s)console.log(s);else{var l=cc.instantiate(c);cc.director.getScene().addChild(l),l.getComponent(a).show(t,e,i,n,o,r)}})},readLevelScores:function(){var t=cc.sys.localStorage.getItem("LEVEL_SCORES");this.levelScores=t?JSON.parse(t):{}},saveLevelScores:function(){var t=JSON.stringify(this.levelScores);cc.sys.localStorage.setItem("LEVEL_SCORES",t)},calcScoreLogic:function(){for(var t in this.totalScore=0,this.minScoreLevel=0,this.min2ScoreLevel=0,this.levelScores){var e=this.levelScores[t];this.totalScore+=e}var i=0;for(console.log(this.totalScore,this.calcTargetScore(i));this.totalScore>=this.calcTargetScore(i);)i++;this.maxLevel=i;var a=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY;for(t=1;t<=this.maxLevel;t++)(e=this.levelScores[t.toString()])||(e=0),e<a||e==a&&this.minScoreLevel>t?(a=e,this.min2ScoreLevel=this.minScoreLevel,this.minScoreLevel=t):(e<n||e==n&&this.min2ScoreLevel>t)&&(n=e,this.min2ScoreLevel=t)},calcTargetScore:function(t){if(this.levelCfg||(this.levelCfg={}),this.levelCfg[t.toString()])return this.levelCfg[t.toString()];var e=1e3;return t>1?(e=this.calcTargetScore(t-1),e+=0==e%2?2e3:3e3,e+=300*Math.floor(t/10)):0==t&&(e=0),this.levelCfg[t.toString()]=e,e},setLevelScore:function(t,e){console.log("setLevelScore",t,e),this.levelScores[t.toString()]=e},calcTargetStr:function(){this.targetStrTab={};var t=0;this.min2ScoreLevel&&0!=this.min2ScoreLevel&&((t=this.levelScores[this.min2ScoreLevel])?t++:t=0);var e=0;if(this.maxLevel){var i=this.levelScores[this.currentLevel];i||(i=0),e=this.calcTargetScore(this.maxLevel)-(this.totalScore-i)}t>e?e>0?(this.targetStrTab.littleTarget=e,this.targetStrTab.littleTargetStr="(\u89e3\u9501\u7b2c"+(this.maxLevel+1)+"\u5173)\n",this.targetStrTab.bigTarget=t,this.targetStrTab.bigTargetStr="(\u8d85\u8fc7\u7b2c"+this.min2ScoreLevel+"\u5173)"):(this.targetStrTab.oneTarget=t,this.targetStrTab.oneTargetStr="(\u8d85\u8fc7\u7b2c"+this.min2ScoreLevel+"\u5173)"):t>0?(this.targetStrTab.littleTarget=t,this.targetStrTab.littleTargetStr="(\u8d85\u8fc7\u7b2c"+this.min2ScoreLevel+"\u5173)",this.targetStrTab.bigTarget=e,this.targetStrTab.bigTargetStr="(\u89e3\u9501\u7b2c"+(this.maxLevel+1)+"\u5173)\n"):(this.targetStrTab.oneTarget=e,this.targetStrTab.oneTargetStr="(\u89e3\u9501\u7b2c"+(this.maxLevel+1)+"\u5173)\n")}},cc._RF.pop()},{"./prefab/ConfirmDialogPrefab.js":"ConfirmDialogPrefab","./prefab/TipPrefab.js":"TipPrefab"}],ConfirmDialogPrefab:[function(t,e){"use strict";cc._RF.push(e,"c7199ySzr1IhI7NQxciQpOR","ConfirmDialogPrefab"),cc.Class({extends:cc.Component,properties:{titleLabel:cc.Label,contentLabel:cc.Label,btn1Node:cc.Node,btn2Node:cc.Node,btn1Label:cc.Label,btn2Label:cc.Label},show:function(t,e,i,a,n,o){this.titleLabel.string=t,this.contentLabel.string=e,this.btn1Label.string=i,this.btn1Cb=a,n?(this.btn2Label.string=n,this.btn2Cb=o):(this.btn1Node.x=0,this.btn2Node.active=!1)},btn1Click:function(){this.btn1Cb(),this.node.destroy()},btn2Click:function(){this.btn2Cb(),this.node.destroy()},fullScreenBtnClick:function(){console.log("fullScreenBtnClick")},dialogBtnClick:function(){console.log("dialogBtnClick")}}),cc._RF.pop()},{}],GameScene:[function(t,e){"use strict";cc._RF.push(e,"e3996EcHbNIBo8DcXtt3l87","GameScene");var i=t("Comm"),a=t("PoolManager"),n=t("../../../load/common/GroupWait"),o=[cc.color(216,267,48),cc.color(74,122,251),cc.color(230,211,79),cc.color(254,0,214),cc.color(17,240,80)];cc.v2(0,-25),cc.v2(0,-25),cc.v2(0,-40),cc.v2(0,-40),cc.v2(0,-35),cc.Class({extends:t("baseGame"),properties:{starPrefab:cc.Prefab,starGrid:cc.Node,bgN:cc.Node,bars:[cc.Node],eliminateEffectPrefab:cc.Prefab,mats:[cc.Material],txtStep:cc.Label,newHeroPre:cc.Prefab,missionLab:cc.Label,overPanel:t("basePanel"),lightAPre:cc.Prefab,readyBattleN:cc.Node,sPowerLab:cc.Label,oPowerLab:cc.Label,bgBgN:cc.Node,handAni:cc.Animation,guideNode:cc.Node,bgs:{default:[],type:cc.SpriteFrame},backBtnN:cc.Node,heroPre:cc.Prefab,roleHeadN:cc.Node,talkLab:cc.Label,recordIcon:cc.Node,panelP:cc.Node},onLoad:function(){var t=this;this.panelP.active=!0,this.guideNode.active=!1,cc.Tween.stopAllByTarget(this.handAni.node),cc.director.on("RecordScreenStart",function(){t&&cc.isValid(t)&&t.recordIcon&&(t.recordIcon.active=!0)})},start:function(){var t,e,n=this;if(this.starGrid.on(cc.Node.EventType.TOUCH_END,function(t){var e=n.starGrid.convertToNodeSpace(t.touch.getLocation());n.touchStar(parseInt(e.x/(n.starGrid.width/i.gridWidth)),parseInt(e.y/(n.starGrid.height/i.gridHeight)))}),a.initPoolByName("eliEffect",this.eliminateEffectPrefab,5),a.initPoolByName("newHero",this.newHeroPre,3),a.initPoolByName("starPrefab",this.starPrefab,0),a.initPoolByName("hero",this.heroPre,0),a.initPoolByName("lightAPre",this.lightAPre,3),cc.director.getCollisionManager().enabled=!0,this.talkLab.node.parent.active=!1,Global.gameType==MyEnum.GameType.Match){var o;cc.find("bg",this.bgN).getComponent(cc.Sprite).spriteFrame=this.bgs[1];var r=1;r=function t(e){return 1==e?7:t(e-1)+Math.floor((e-1)/2)+2}(playerInfo.Grade),r=Math.floor(r+3*Math.random()-1),this.misCfg=null!=(o=Config.mission[r-1])?o:Config.mission[Config.mission.length-1],this.missionLab.string="\u7ade\u6280\u573a",this.backBtnN.active=!1,this.roleHeadN.active=!0,cc.find("oHead/icon",this.roleHeadN).getComponent(cc.Sprite).spriteFrame=Global.MatchInfo.oInfo.sf;var s=Global.MatchInfo.oInfo.name;cc.find("oHead/nameLab",this.roleHeadN).getComponent(cc.Label).string=s.length>4?s.substr(0,4)+"...":s,this.talkLab.node.parent.active=!0,cc.tween(this.talkLab.node.parent).set({scale:0}).delay(.2).to(.3,{scale:1},{easing:"backIn"}).start();var c=Config.talk[3],l=c[Math.floor(c.length*Math.random())];this.talkLab.string=l.desc}else if(Global.gameType==MyEnum.GameType.Endless){cc.find("bg",this.bgN).getComponent(cc.Sprite).spriteFrame=this.bgs[1],this.misCfg=Global.endlessConfig,this.missionLab.string="\u6bd4\u6b66\u5927\u4f1a",this.roleHeadN.active=!0,cc.find("oHead/icon",this.roleHeadN).getComponent(cc.Sprite).spriteFrame=Global.MatchInfo.oInfo.sf;var h=Global.MatchInfo.oInfo.name;cc.find("oHead/nameLab",this.roleHeadN).getComponent(cc.Label).string=h.length>4?h.substr(0,4)+"...":h}else Global.gameType==MyEnum.GameType.Boss?(this.misCfg=Global.missionConfig,this.missionLab.string="\u7b2c "+this.misCfg.level+" \u5c42",this.roleHeadN.active=!1):(this.misCfg=Config.mission[playerInfo.MissionID-1],this.missionLab.string="\u7b2c "+playerInfo.MissionID+" \u5173",this.roleHeadN.active=!1);console.log("this.misCfg",this.misCfg),this.enemyList=[],this.heroList=[],this.overPanel.node.active=!1,Global.gameType==MyEnum.GameType.Endless?this.initBattleMeetingEnemy():this.initEnemy(),this.leftStep=Number(this.misCfg.stepNum),(null==(t=playerInfo.tempAttr)?void 0:t.clean_num)&&(this.leftStep+=null==(e=playerInfo.tempAttr)?void 0:e.clean_num);var d=playerInfo.getAdditive("clean_num");d&&(this.leftStep+=d),this.updateCurStep(),this.xMaxOffset=625,this.xSpringBackOffset=125,this.proList=[0,0,0,0,0],this.typeList=[0,0,0,0,0],this.scaleList=[];for(var f=0;f<5;f++)this.scaleList[f]=this.bars[f].getChildByName("icon1").scale;this.initUI(),this.starGame(),Global.gameCtrl=this},initUI:function(){for(var t in this.addStep=5,this.readyBattleN.active=!1,this.bars)this.bars[t].getComponent(cc.ProgressBar).progress=.01;this.recordIcon.active=!1},getRandomType:function(){if(!this.weight_list){var t=this.misCfg.weight_list.split(",");for(var e in t)""==t[e]?t[e]=0:t[e]=Number(t[e]);for(var i in this.weight_list=[],t){var a=t[i]*playerInfo.getRandomBoxRate(Number(i)+1);i>0&&(a+=this.weight_list[i-1]),this.weight_list.push(a)}}var n=this.weight_list[this.weight_list.length-1],o=Math.random()*n;for(var r in this.weight_list)if(o<this.weight_list[r])return Number(r)+1},updateCurStep:function(){this.txtStep.string=this.leftStep,this.leftStep<=0?this.txtStep.node.parent.active=!1:this.txtStep.node.parent.active=!0},starGame:function(){this.initStatus(),this.initGrid(),i.calcTargetStr(),this.gameState=MyEnum.GameState.Clear},initStatus:function(){this.stVar={},this.stVar.selected=!1,this.totalScore=0},initGrid:function(){var t=this;if(this.gridStarUi)for(var e=0;e<i.gridWidth;e++)for(var a=0;a<i.gridHeight;a++)this.gridStarUi[e][a]&&this.gridStarUi[e][a].destroy();for(var n=[],o=[],r=0;r<i.gridWidth;r++){n[r]=[],o[r]=[];for(var s=0;s<i.gridHeight;s++)n[r][s]=0}this.gridData=n,this.gridStarUi=o,this.starGrid.width=80*i.gridWidth,this.starGrid.height=80*i.gridHeight,this.fallDownStar(!0,function(){Global.gameType==MyEnum.GameType.Normal&&(Utils.checkAndStartGuide("mission_"+playerInfo.MissionID),cc.director.on("guidEnd",function(){console.log("GuideEvent","\u6536\u5230guidEnd"),t.handNum=2,t.showHand()}))})},showHand:function(){console.log("GuideEvent","showHand"),platformAdapter.aldSendEvent("guide",{desc:"\u5f15\u5bfc"+this.handNum});var t=this.getGuideClickNodes(),e=new cc.Vec2;for(var i in t){var a=t[i];if(a){var n=a.convertToWorldSpaceAR(cc.Vec2.ZERO);i==Math.floor(t.length/2)&&(e=n)}}console.log("GuideEvent:handPos",e),this.playHandAni(e,"click",["\u7ee7\u7eed\u6d88\u9664\n\u53ec\u5524\u66f4\u591a\u52c7\u58eb","\u505a\u7684\u597d\uff01\n\u63a5\u4e0b\u6765\u5c31\u4ea4\u7ed9\u4f60\u4e86"][this.handNum-2]),this.handNum++},playHandAni:function(t,e,i){var a=this.handAni.node.parent.convertToNodeSpaceAR(t);console.log("GuideEvent:pos",a),this.handAni.node.position=a,this.guideNode.active=!0,this.guideNode.getComponentInChildren(cc.Label).string=i,this.handAni.play(e)},touchStar:function(t,e){var i,a=this;this.touching||this.leftStep<=0||0!=this.gridData[t][e]&&(this.touching=!0,this.stVar.connectStars=[[t,e]],this.checkStar(t,e),this.stVar.connectStars.length>=2?(this.guideNode.active=!1,cc.Tween.stopAllByTarget(this.handAni.node),this.isFirst_iii||(this.isFirst_iii=!0,Global.showOverFre=Global.showOverFre||0,Global.gameType==MyEnum.GameType.Normal&&Global.showOverFre%2==0&&this.startRecord()),Utils.emitGuideEvent(MyEnum.GuideEvents.StartCleanStar),this.leftStep--,this.updateCurStep(),this.cleanGw=null!=(i=this.cleanGw)?i:new n(null),this.cleanOnce(t,e,function(){a.handNum&&a.handNum<4&&a.showHand(),a.IsShowHand&&(Global.gameCtrl.IsShowHand=!1,cc.director.emit("guidEnd")),a.touching=!1}).then(function(){console.log("console.log()",a.cleanGw.isDone(),a.leftStep,a.cleanGw),a.leftStep<=0&&a.cleanGw.isDone()&&a.readyBattle()})):this.touching=!1)},readyBattle:function(){if(console.log("readyBattlereadyBattle start"),this.readyBattleN.active=!0,cc.find("btn_add/tip",this.readyBattleN).active=Number(this.sPowerLab.string)<Number(this.oPowerLab.string),cc.find("btn_add/hand",this.readyBattleN).active=Number(this.sPowerLab.string)<Number(this.oPowerLab.string)&&1095==platformAdapter.scene,this.addStep){if(Number(this.sPowerLab.string)<Number(this.oPowerLab.string)){var t=cc.find("btn_add",this.readyBattleN);cc.tween(t).repeatForever(cc.tween().by(.4,{scale:.1}).by(.4,{scale:-.1})).start()}this.gameState=MyEnum.GameState.Ready}else this.startBattle()},startBattle:function(){var t=this;if(Global.gameType==MyEnum.GameType.Match){if(this.gameState==MyEnum.GameState.Buff)return;this.gameState=MyEnum.GameState.Buff;var e=!0,i=new n(function(){e&&t._startBattle()},1);cc.find("btn_start",this.readyBattleN).active=!1,cc.find("btn_add",this.readyBattleN).active=!1,this.openZhuXianBuffPanel(function(a){if(a)if("role_num"==a.att_type)for(var n=0,o=0;o<Number(a.value);++o)for(var r=[1,2,4,8],s=function(e){a.e_id&r[e-1]&&(i.wait(),t.scheduleOnce(function(){t.addHero(e,function(){i.done()})},.1*n),n++)},c=1;c<=r.length;++c)s(c);else if("clean_num"==a.att_type)t.leftStep+=Number(a.value),t.updateCurStep(),t.gameState=MyEnum.GameState.Clear,t.readyBattleN.active=!1,e=!1;else{for(var l in t.heroList)t.heroList[l].addBuff(a);t.updatePower()}i.done()})}else this._startBattle()},_startBattle:function(){if(this.gameState!=MyEnum.GameState.Battle){this.talkLab.node.parent.active=!1;var t=playerInfo.getValueByKey("max_power")||0;for(var e in t<Number(this.sPowerLab.string)&&playerInfo.setValueByKey("max_power",Number(this.sPowerLab.string)),console.log(" Global.audioCtrl=========",Global.audioCtrl),Global.audioCtrl.playWorldBgm(),this.gameState=MyEnum.GameState.Battle,cc.find("btn_start",this.readyBattleN).active=!1,cc.find("btn_add",this.readyBattleN).active=!1,cc.find("eggColor_1",this.readyBattleN).active=!1,cc.find("eggColor_2",this.readyBattleN).active=!1,this.bars)cc.tween(this.bars[e]).to(.3,{opacity:0}).start();var i=cc.find("bg",this.readyBattleN);console.log("this.starGrid",this.starGrid,i),cc.tween(this.bgBgN).to(.2,{height:780},{easing:"sineInOut"}).call(function(){}).start(),cc.tween(i).to(.2,{height:780},{easing:"sineInOut"}).start(),cc.tween(this.sPowerLab.node.parent).by(.2,{y:-110},{easing:"sineInOut"}).start(),window.tt||platformAdapter.changeCustomAdState(!0).catch(function(){platformAdapter.changeBannerState(!0).catch(function(){})}),platformAdapter.changeCustomAdState3(!0).catch(function(){})}},onClickedStartBtn:function(){platformAdapter.aldSendEvent("onClickedStartBtn",{dfesc:"\u70b9\u51fb\u5f00\u59cb\u6218\u6597\u6309\u94ae"}),platformAdapter.updateBannerAdState(!1),this.startBattle()},onClickedAddStepBtn:function(){this.leftStep+=this.addStep,this.updateCurStep(),this.gameState=MyEnum.GameState.Clear,this.readyBattleN.active=!1,Global.gameType==MyEnum.GameType.Normal&&platformAdapter.sendMissionRunningEvent({stageId:playerInfo.MissionID,stageName:"\u7b2c"+playerInfo.MissionID+"\u5173",userId:platformAdapter.openId,event:"addStep",params:{itemName:"\u6b65\u6570",desc:"\u589e\u52a0\u6b65\u6570"}})},touchStart:function(t){this.selectInfo=null;var e=this.starGrid.convertToNodeSpace(t.touch.getLocation()),a=parseInt(e.x/(this.starGrid.width/i.gridWidth)),n=parseInt(e.y/(this.starGrid.height/i.gridHeight));console.log(e.x,a,n,"xxxxxxxx yyyyyyyyyy"),this.leftStep<=0||this.gridData[a]&&this.gridData[a][n]&&(this.selectInfo={list:[[a,n]],type:this.gridData[a][n]},this.addSelectAction(a,n))},addSelectAction:function(t,e){var i=this.gridStarUi[t][e];cc.tween(i).repeatForever(cc.tween().to(.2,{scale:1.05}).to(.2,{scale:1})).start()},clearSelectAction:function(t,e){var i=this.gridStarUi[t][e];cc.Tween.stopAllByTarget(i),i.scale=1},touchMove:function(t){if(console.log("=========touchMove===========safawd"),this.selectInfo){var e=this.starGrid.convertToNodeSpace(t.touch.getLocation()),a=parseInt(e.x/(this.starGrid.width/i.gridWidth)),n=parseInt(e.y/(this.starGrid.height/i.gridHeight));if(this.gridData[a]&&this.gridData[a][n]){var o=this.gridData[a][n];if(console.log("=========touchMove==========="),o==this.selectInfo.type){var r=this.selectInfo.list[this.selectInfo.list.length-1];if(this.selectInfo.list.length>1){var s=this.selectInfo.list[this.selectInfo.list.length-2];if(s[0]==a&&s[1]==n){var c=this.selectInfo.list.pop();return console.log(c,r,"aaaaaaaaaaaa"),void this.clearSelectAction(c[0],c[1])}}if(Math.abs(a-r[0])>1||Math.abs(n-r[1])>1)console.log("=========touchMove=========== 2",a,n,r);else{for(var l in this.selectInfo.list)if(a==this.selectInfo.list[l][0]&&n==this.selectInfo.list[l][1])return void console.log("=========touchMove=========== 3");this.selectInfo.list.push([a,n]),this.addSelectAction(a,n)}}else console.log("=========touchMove=========== 1",o,this.selectInfo.type)}}},touchEnd:function(){var t=this;if(this.selectInfo){for(var e in this.selectInfo.list)this.clearSelectAction(this.selectInfo.list[e][0],this.selectInfo.list[e][1]);this.selectInfo.list.length<2||(this.leftStep--,this.updateCurStep(),this.clearConnect(this.selectInfo.type,function(){}).then(function(){t.leftStep<=0&&(t.gameState=MyEnum.GameState.Ready)}))}},clearConnect:function(t){var e=this;return new Promise(function(i){for(var o=new n(function(){e.fallDownStar()}),r=new n(function(){i()}),s=.1*(e.selectInfo.list.length-2)+1,c=function(){var i=e.selectInfo.list[l],n=e.gridStarUi[i[0]][i[1]];r.wait(),e.playElmEffect(n,e.gridData[i[0]][i[1]]-1,function(){e.addProgress(t,s,function(){r.done()})}),o.wait(),cc.tween(n).to(.1,{scale:1.1}).to(.1,{scale:1}).by(.3,{angle:360,scale:-1,opacity:-250}).call(function(){a.pushPoolNodeByName("starPrefab",n),e.gridData[i[0]][i[1]]=0,console.log("11111111111"),o.done()}).start()},l=e.selectInfo.list.length-1;l>=0;l--)c()})},checkStar:function(t,e){this.stVar.connectStars=this.checkStarNew(t,e)},getMaxConnect:function(){for(var t={},e=[],a=0;a<i.gridWidth;a++)for(var n=0;n<i.gridHeight;n++){var o=this.checkStarNew(a,n,t);o.length>=2&&e.push(o)}var r=[];for(var s in e)e[s].length>r.length&&(r=e[s]);return r},getGuideClickNodes:function(){var t=this.getMaxConnect(),e=[];for(var i in t){var a=t[i],n=this.gridStarUi[a[0]][a[1]];e.push(n)}return e},checkStarNew:function(t,e,i){var a;i=null!=(a=i)?a:{};for(var n=this.gridData[t][e],o=[],r=[[t,e]];r.length>0;){var s=r.shift(),c=s[0]+"_"+s[1];i[c]||this.inGrid(s[0],s[1])&&this.gridData[s[0]][s[1]]==n&&(o.push(s),i[c]=!0,r.push([s[0]+1,s[1]]),r.push([s[0]-1,s[1]]),r.push([s[0],s[1]-1]),r.push([s[0],s[1]+1]))}return o},inGrid:function(t,e){return t>=0&&t<i.gridWidth&&e>=0&&e<i.gridHeight},connectContain:function(t,e){for(var i=this.stVar.connectStars.length-1;i>=0;i--){var a=this.stVar.connectStars[i];if(a[0]==t&&a[1]==e)return!0}return!1},setConnectStarSelect:function(t){for(var e=this.stVar.connectStars.length-1;e>=0;e--){var i=this.stVar.connectStars[e];this.gridStarUi[i[0]][i[1]].getComponent("StarPrefab").setSelected(t)}this.stVar.selected=t},cleanOnce:function(t,e,i){var a=this;return new Promise(function(n){var o=a.gridStarUi[t][e].getComponent("StarPrefab").starType;a.stVar.connectStars.length,a.cleanGw.wait(),a.clearConnectStar(o,function(){a.cleanGw.done(),n()}).then(function(){a.fallDownStar(!1,i)})})},viewMoveToPos:function(t){var e=t.x,i=this.xMaxOffset-this.xSpringBackOffset;e>i?e=i:e<-i&&(e=-i);var a=-e;Math.abs(this.bgN.x-a),this.bgN.x=cc.misc.lerp(this.bgN.x,a,.05)},autoFollowFirstHumanRole:function(){if(!(this.heroList.length<=0)){var t=-3e3;this.heroList.forEach(function(e){var i=e.node;0==i.getComponent(cc.Collider).tag&&i.x>t&&(t=i.x)}),this.viewMoveToPos(cc.v2(t-320,0))}},addProgress:function(t,e,i){var a=this,o=this.bars[t-1].getComponent(cc.ProgressBar),r=.2*playerInfo.getExpendRate(t),s=this.proList[t-1]+r*e;this.proList[t-1]=s;var c=this.bars[t-1].getChildByName("icon1").getComponent(cc.Sprite),l=this.bars[t-1].getChildByName("light1"),h=new n(i,1);if(s>=1){for(var d=0;s>=1;)s=Math.max(s-1,.01),this.proList[t-1]=s,h.wait(),this.scheduleOnce(function(){var e;e=function(){h.done()},o.progress=1,c.setMaterial(0,a.mats[1]),l.active=!0,cc.tween(c.node).to(.12,{scale:1.5*a.scaleList[t-1]}).to(.09,{scale:a.scaleList[t-1]}).call(function(){l.active=!1,c.setMaterial(0,a.mats[0]),a.addHero(t,e),c.node.scale=a.scaleList[t-1],c.node.opacity=255,o.progress=a.proList[t-1]}).start()},.2*d),d++;h.done()}else o.progress=s,h.done()},onDestroy:function(){Global.audioCtrl.stopWorldBgm(),cc.director.off("RecordScreenStart")},showMatchOverPanel:function(t){var e=this;Utils.loadBundle("game",function(i,a){a.load("panel/matchOverPanel/matchOverPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,n.getComponent("basePanel").show(t)})})},showTipPanel:function(t,e){var i=this;this.tipPanel?(this.tipPanel.node.active=!0,this.tipPanel.show(t,e)):(Global.openMask(),Utils.loadBundle("main_a",function(a,n){n.load("panel/tipPanel/tipPanel",cc.Prefab,function(a,n){var o=cc.instantiate(n);o.parent=i.panelParent,i.tipPanel=o.getComponent("basePanel"),i.tipPanel.show(t,e),Global.closeMask()})}))},openZhuXianBuffPanel:function(t){var e=this;Utils.loadBundle("main_a",function(i,a){a.load("panel/zhuxianbuffPanel/zhuxianbuffPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,n.getComponent("basePanel").show(t)})})},openBonusPanel:function(t){var e=this;this.bonusPanel?(this.bonusPanel.node.active=!0,this.bonusPanel.show(t,function(){e.sPowerLab.string=Math.floor(1.2*Number(e.sPowerLab.string))})):(Global.openMask(),Utils.loadBundle("main_a",function(i,a){a.load("panel/bonusPanel/bonusPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,e.bonusPanel=n.getComponent("basePanel"),e.bonusPanel.show(t,function(){e.sPowerLab.string=Math.floor(1.2*Number(e.sPowerLab.string))}),Global.closeMask()})}))},showChaojikaijuPanel:function(t){var e=this;Utils.loadBundle("main_a",function(i,a){a.load("panel/chaojikaijuPanel/chaojikaijuPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,n.getComponent("basePanel").show(t)})})},showMeetingOverPanel:function(t,e,i){var a=this;Utils.loadBundle("game",function(n,o){o.load("panel/meetingOverPanel/meetingOverPanel",cc.Prefab,function(n,o){var r=cc.instantiate(o);r.parent=a.panelParent,r.getComponent("basePanel").show(t,e,i)})})},onBattleOver:function(t){var e=this;if(platformAdapter.hideGameCustomAd(),this.gameState=MyEnum.GameState.Over,Global.audioCtrl.stopWorldBgm(),playerInfo.clearTempAttr(),t?Global.audioCtrl.playWinClip():Global.audioCtrl.playFailClip(),Global.gameType==MyEnum.GameType.Match)t?playerInfo.Grade++:playerInfo.Grade=Math.max(1,playerInfo.Grade-1),setTimeout(function(){e.showMatchOverPanel(t)},2e3);else if(Global.gameType==MyEnum.GameType.Endless){var i=playerInfo.getBattleMeetingData(),a=i.rank,n=this.misCfg.info.rank;if(t){var o=i.roleList,r=o[a-1];r||(r={rank:n,nIndex:-1,hIndex:-1,power:i.power}),r.rank=n;for(var s=a-1;s>=n;--s)console.log("oldRank, newRank",s),o[s]=o[s-1],o[s].rank=s+1;o[n-1]=r,i.rank=n,playerInfo.setBattleMeetingData(i)}console.log("oldRank, newRank",this.misCfg,i,a,n),this.showMeetingOverPanel(t,a,n)}else if(Global.gameType==MyEnum.GameType.Boss){if(t){var c=playerInfo.getValueByKey("bossChallengeData")||[],l=c[this.misCfg.type]||{lv:1};l.lv++,c[this.misCfg.type]=l,playerInfo.setValueByKey("bossChallengeData",c),platformAdapter.aldSendEvent("bossChallengeSuc",{desc:"\u6311\u6218boss\u6210\u529f"})}else platformAdapter.aldSendEvent("bossChallengeFail",{desc:"\u6311\u6218boss\u5931\u8d25"});this.scheduleOnce(function(){e&&e.overPanel&&(e.overPanel.node.active=!0,e.overPanel.show(t,e.misCfg))},2)}else{var h="normal_battle_v",d=playerInfo.getValueByKey(h)||0;t?(platformAdapter.sendMissionEndEvent({stageId:playerInfo.MissionID,stageName:"\u7b2c"+playerInfo.MissionID+"\u5173",userId:platformAdapter.openId,event:"complete",params:{desc:"\u5173\u5361\u5b8c\u6210"}}),playerInfo.MissionID++,d<0&&(d=0),d++):(platformAdapter.sendMissionEndEvent({stageId:playerInfo.MissionID,stageName:"\u7b2c"+playerInfo.MissionID+"\u5173",userId:platformAdapter.openId,event:"fail",params:{desc:"\u5173\u5361\u5931\u8d25"}}),d>0&&(d=0),d--),playerInfo.setValueByKey(h,d),d<0?this.scheduleOnce(function(){e.showChaojikaijuPanel(function(){Global.autoOpenBonus=!0,Utils.switchScene("main")})},2):this.scheduleOnce(function(){e&&e.overPanel&&(e.overPanel.node.active=!0,e.overPanel.show(t,e.misCfg))},2)}},getPosX:function(t,e,i){var a;void 0===i&&(i=!1);var n=1;switch(i&&(n=-1),t){case 0:a=40;break;case 1:a=80;break;case 2:a=0;break;case 3:case 4:a=80}return e+a*n},backTOMenu:function(){platformAdapter.stopRecordScreen(),console.log("backTOMenu"),playerInfo.physicalIsUnchanged()||Global.gameType!=MyEnum.GameType.Normal?Utils.switchScene("main"):this.showTipPanel(function(){Utils.switchScene("main")},function(){})},clearConnectStar:function(t,e){var i=this;return new Promise(function(t){for(var o=new n(function(){t()}),r=new n(e,1),s=function(t){var e=i.stVar.connectStars[t],n=i.gridStarUi[e[0]][e[1]];n.getComponent("StarPrefab").setToLight(),n.zIndex=100,i.gridStarUi[e[0]][e[1]]=null,o.wait();var s=i.gridData[e[0]][e[1]];i.gridData[e[0]][e[1]]=0,r.wait(),cc.tween(n).delay(.075*t).call(function(){i.playElmEffect(n,s-1,function(){i.addProgress(s,1,function(){r.done()})}),Global.audioCtrl.playHCAudio()}).to(.1,{scale:1.1}).to(.1,{scale:1}).parallel(cc.tween().by(.3,{angle:360,scale:-1,opacity:-250}),cc.tween().delay(.15).call(function(){o.done()})).call(function(){a.pushPoolNodeByName("starPrefab",n)}).start()},c=i.stVar.connectStars.length-1;c>=0;c--)s(c);r.done()})},fallDownStar:function(t,e){for(var a=new n(e,1),o=0;o<i.gridWidth;o++){for(var r=0,s=0;s<i.gridHeight;s++)0==this.gridData[o][s]&&r++,r>0&&this.gridData[o][s]>0&&(this.gridData[o][s-r]=this.gridData[o][s],this.gridData[o][s]=0,this.gridStarUi[o][s].getComponent("StarPrefab").goTo(o,s-r,0),this.gridStarUi[o][s-r]=this.gridStarUi[o][s],this.gridStarUi[o][s]=null);r>0&&(a.wait(),this.fillEmptyStar(o,r,t,function(){a.done()}))}a.done()},fillEmptyStar:function(t,e,o,r){for(var s=this,c=new n(r,1),l=function(n){var r=n;c.wait(),s.scheduleOnce(function(){var n=a.getPoolNodeByName("starPrefab"),l=n.getComponent("StarPrefab");n.parent=s.starGrid;var h=s.getRandomType();l.setType(h),o?(s.gridData[t][i.gridHeight+r-e]=h,s.gridStarUi[t][i.gridHeight+r-e]=n,l.setGridXY(t,i.gridHeight+r-e),c.done()):(s.gridData[t][i.gridHeight+r-e]=h,s.gridStarUi[t][i.gridHeight+r-e]=n,l.setGridXY(t,i.gridHeight),l.goTo(t,i.gridHeight+r-e,0,function(){c.done()}))},o?.05*r:.125*r)},h=0;h<e;h++)l(h);c.done()},fallLeftStar:function(){for(var t=0,e=0;e<i.gridWidth;e++)if(0==this.gridData[e][0]&&t++,0!=this.gridData[e][0]&&0!=t)for(var a=0;a<i.gridHeight&&this.gridData[e][a]>0;a++)this.gridData[e-t][a]=this.gridData[e][a],this.gridData[e][a]=0,this.gridStarUi[e][a].getComponent("StarPrefab").goTo(e-t,a,.1),this.gridStarUi[e-t][a]=this.gridStarUi[e][a],this.gridStarUi[e][a]=null},checkOver:function(){for(var t=0;t<i.gridWidth;t++)for(var e=0;e<i.gridHeight;e++){var a=this.gridData[t][e];if(0==a)break;for(var n=[[t+1,e],[t-1,e],[t,e-1],[t,e+1]],o=0;o<n.length;o++){var r=n[o][0],s=n[o][1];if(this.inGrid(r,s)&&this.gridData[r][s]==a)return!1}}return!0},checkCount:function(){for(var t=0,e=0;e<i.gridWidth;e++)for(var a=0;a<i.gridHeight;a++)this.gridData[e][a]>0&&t++;return t},targetButtonClick:function(){var t;t=i.targetStrTab.oneTarget?"\u76ee\u6807:"+i.targetStrTab.oneTarget+"\u5206"+i.targetStrTab.oneTargetStr:"\u5c0f\u76ee\u6807:"+i.targetStrTab.littleTarget+"\u5206"+i.targetStrTab.littleTargetStr+"\n\u5927\u76ee\u6807:"+i.targetStrTab.bigTarget+"\u5206"+i.targetStrTab.bigTargetStr,console.log(t),i.confirm("\u76ee\u6807",t,"\u786e\u5b9a",function(){})},playElmEffect:function(t,e,i){for(var r=t.convertToWorldSpaceAR(cc.Vec2.ZERO),s=this.bars[e].convertToWorldSpaceAR(cc.v2(0,0)),c=new n(i),l=function(t){var i=a.getPoolNodeByName("eliEffect");i.active=!0,i.scale=2*Math.random()+1.5,i.opacity=255,i.position=r,i.zIndex=999,i.parent=cc.director.getScene(),i.color=o[e];var n=cc.v2(s.x+40*Math.random()-20,s.y+40*Math.random()-20),l=r.add(cc.v2(0,60).rotate(2*Math.PI/5*t+Math.random()*Math.PI*2/5)),h=n.sub(l),d=[l.add(cc.v2(h.x/10,0)),n.add(cc.v2(0,-h.y/10)),n],f=.4*Math.random()+.3;c.wait(),i.runAction(cc.sequence(cc.moveTo(.2,l).easing(cc.easeSineOut()),cc.bezierTo(f,d).easing(cc.easeOut(.5)),cc.callFunc(function(){a.pushPoolNodeByName("eliEffect",i),c.done()})))},h=0;h<5;++h)l(h)},update:function(){this.gameState,MyEnum.GameState.Battle}}),cc._RF.pop()},{"../../../load/common/GroupWait":void 0,Comm:"Comm",PoolManager:void 0,baseGame:"baseGame",basePanel:void 0}],StarPrefab:[function(t,e){"use strict";cc._RF.push(e,"22bb0VNWAxF/ZMJwZXVIaIx","StarPrefab");var i=t("Comm");cc.Class({extends:cc.Component,properties:{pic1:cc.SpriteFrame,pic2:cc.SpriteFrame,pic3:cc.SpriteFrame,pic4:cc.SpriteFrame,pic5:cc.SpriteFrame,picLights:{default:[],type:cc.SpriteFrame}},onLoad:function(){},setType:function(t){this.starType=t,this.getComponent(cc.Sprite).spriteFrame=this["pic"+t],this.node.scale=1,this.node.angle=0,this.node.opacity=255},setToLight:function(){this.getComponent(cc.Sprite).spriteFrame=this.picLights[this.starType-1]},setGridXY:function(t,e){this.gridX=t,this.gridY=e,this.node.setPosition(80*(t-i.gridWidth/2)+40,80*(e-i.gridHeight/2)+40)},setSelected:function(t){t?this.node.runAction(cc.repeatForever(cc.sequence(cc.scaleTo(.3,1),cc.scaleTo(.3,1.17)))):(this.node.stopAllActions(),this.node.setScale(1.17))},goTo:function(t,e,a,n){var o=this;this.gridX=t,this.gridY=e;var r=80*(e-i.gridHeight/2)+40-this.node.y;this.node.zIndex=e,this.node.runAction(cc.sequence(cc.delayTime(a),cc.moveTo(Math.abs(r)/64*.1,cc.v2(80*(t-i.gridWidth/2)+40,80*(e-i.gridHeight/2)+40)).easing({easing:function(t){return 0===t?0:(t-=1)*t*(2*t+1)+1},reverse:function(){return _easeBackInObj}}),cc.callFunc(function(){n&&n()}))),this.node.runAction(function(t){var e=cc.delayTime(t),a=80*(i.gridHeight-i.gridHeight/2)+40;return e.update=function(){o.node.y<=a?o.node.opacity=255:o.node.opacity=Math.max(255-5*(o.node.y-a),0)},e}(a+Math.abs(r)/64*.1))},moveAction:function(t,e,a){var n=this,o=(this.node.position,cc.v2(80*(t-i.gridWidth/2)+40,80*(e-i.gridHeight/2)+40)),r=-10,s=100;this.moving=!0,this.node.opacity=0,this.schedule(function t(){n.node.opacity=255,r-=.02*s,n.node.y+=r,n.node.y<o.y?(s>0&&(r/=10),s=-8*(o.y-n.node.y)/4-10):s<0&&n.node.y>o.y&&(n.node.y=o.y,n.unschedule(t))},.02,cc.macro.REPEAT_FOREVER,a)}}),cc._RF.pop()},{Comm:"Comm"}],TipPrefab:[function(t,e){"use strict";cc._RF.push(e,"2fc39ba/flCCaXZ48+4ZaMH","TipPrefab"),cc.Class({extends:cc.Component,properties:{tipLabel:cc.Label,tipBg:cc.Node},show:function(t){var e=this;this.tipLabel.string=t,this.node.setPosition(cc.director.getWinSize().width/2,100),this.node.runAction(cc.sequence(cc.delayTime(2),cc.fadeOut(.3),cc.callFunc(function(){e.node.destroy()})))}}),cc._RF.pop()},{}],attrShowList:[function(t,e){"use strict";cc._RF.push(e,"7325b7/NGJMnaHa7HrC/isZ","attrShowList"),cc.Class({extends:cc.Component,properties:{itemN:cc.Node},addBuff:function(){},onLoad:function(){this.itemList=[this.itemN],this.buffList=[],this.updateList()},updateList:function(){for(var t in this.itemList)this.itemList[t].active=!1;var e=0,i=playerInfo.tempAttr;for(var a in i)for(var n in i[a]){var o=i[a][n],r=this.itemList[e];r||((r=cc.instantiate(this.itemN)).parent=this.itemN.parent,this.itemList.push(r)),r.active=!0,console.log(" MyEnum.AttrNames[attr]",MyEnum.AttrNames[n],n,i[a],a,i);var s=cc.find("lab",r).getComponent(cc.Label);s.string=MyEnum.RoleName[a]+MyEnum.AttrNames[n].format(o),s.node.color=cc.Color.WHITE.fromHEX(["#DB132F","#3589FF","#EFC82C","#EB52D3"][a-1]),e++}}}),cc._RF.pop()},{}],baseGame:[function(t,e){"use strict";cc._RF.push(e,"de591zThRpOe6SxjvO8abaB","baseGame");var i=t("PoolManager");cc.Class({extends:cc.Component,properties:{fightP:cc.Node,panelParent:cc.Node,gjSf:cc.SpriteFrame,bossN:cc.Prefab},initEnemy:function(t){var e=this,i=this.misCfg.monster.split("|"),a=[];for(var n in i){var o=i[n].split(",");a.push(o)}console.log("enemy_list",a);var r=0,s={},c=function(i){var n=a[i],o=Number(n[0]),c=Number(n[1]),l=Number(n[2])||1,h=Number(n[3])||1,d=Config.monster[o],f=Config.strength[c+""+l],u=Number(d.modelID),g=Config.skin[u-1],p=Number(g.e_id);s[p]||(s[p]=0);for(var v=0;v<h;v++)r++,e.scheduleOnce(function(){Number(d.id)>6e5?e.addBoss(u,l,s[p],Number(d.modelsize),f,t):e.addEnemy(u,l,s[p],Number(d.modelsize),f,t),s[p]++},.1*r)};for(var l in a)c(l)},initBattleMeetingEnemy:function(){var t=this,e=this.misCfg.info.eList;console.log("initBattleMeetingEnemy eList",e);var i=0,a=function(a){var n=e[a];if(n.num<=0)return"continue";for(var o=function(e){i++,t.scheduleOnce(function(){t.addMeetingEnemy(Number(a)+1,n.lv,e)},.1*i)},r=0;r<n.num;r++)o(r)};for(var n in e)a(n)},addMeetingEnemy:function(t,e,a){var n=i.getPoolNodeByName("hero");n.parent=this.fightP;var o=this.getRolePos(t,a),r={cfg:{type:t},level:e,attr:Utils.getStudentInfo({id:t,eLevel:e}),skinId:t};return n.getComponent("hero").updateInfo(this,r,1),n.position=o,n.zIndex=-o.y,this.enemyList.push(n.getComponent("hero")),this.updatePower(),n},fun:function(t,e){return 1==t?e:2==t?e-1:2*this.fun(t-1,e)},getRoleY:function(t,e,i){void 0===i&&(i=4);for(var a=1,n=0,o=t;!((n=this.fun(a,i))>o);)a++,o-=n;return 1==a?e/(i-1)*o:e/n*(o+.5)},getRolePos:function(t,e,i){var a={1:[-60,60,60],2:[-120,70,70],3:[0,50,80],4:[-100,200,50]}[t],n=a[0],o=a[1],r=a[2]||80,s=Math.floor((e+1)/2),c=e%2!=0,l=this.getRoleY(s,r,3);return n-=.055*Math.sqrt(l*l*l),c?o+=l:o-=l,n-=100,cc.v2(i?n:-n,o)},addHero:function(t,e,a){var n=i.getPoolNodeByName("hero");n.parent=this.fightP;var o=this.getRolePos(t,this.typeList[t-1],!0),r=playerInfo.getAdditive(t),s=playerInfo.ELevels[t-1]+playerInfo.getAddLevel(t),c={cfg:{type:t},level:s,attr:Utils.getStudentInfo({id:t,eLevel:s},r),skinId:playerInfo.CurSkin[t-1]};if(n.getComponent("hero").updateInfo(this,c,0),a)n.position=o,n.zIndex=-o.y;else{n.position=this.fightP.convertToNodeSpaceAR(this.bars[t-1].convertToWorldSpaceAR(cc.Vec2.ZERO));var l=o,h=cc.v2(2*l.x/3+n.x/3,l.y+(l.y-n.y)/20+100);cc.tween(n).set({scale:.8*n.scale}).parallel(cc.tween().bezierTo(.5,h,h,l),cc.tween().to(.5,{scale:n.scale},{easing:"backOut"})).call(function(){n.zIndex=-o.y,e&&e()}).start()}return this.typeList[t-1]++,this.heroList.push(n.getComponent("hero")),this.updatePower(),n},addEnemy:function(t,e,a,n,o,r){var s=Config.skin[t-1],c=Number(s.e_id),l=i.getPoolNodeByName("hero");l.parent=this.fightP,l.position=this.getRolePos(c,a);var h=Utils.getMonsterInfo(o);console.log(r,"addEnemy rate"),r&&(h.hp*=r,h.atk*=r,h.defense*=r);var d={cfg:{type:c},level:e,attr:h,skinId:t};return l.getComponent("hero").updateInfo(this,d,1,n),l.zIndex=-l.y,this.enemyList.push(l.getComponent("hero")),this.updatePower(),l},addBoss:function(t,e,i,a,n,o){var r=Config.skin[t-1],s=Number(r.e_id),c=cc.instantiate(this.bossN);c.parent=this.fightP,c.position=cc.v2(200,0);var l=Utils.getMonsterInfo(n);console.log(o,"addEnemy rate"),o&&(l.hp*=o,l.atk*=o,l.defense*=o);var h={cfg:{type:s},level:e,attr:l,skinId:t};return c.getComponent("hero").updateInfo(this,h,1,a),c.zIndex=-c.y,this.enemyList.push(c.getComponent("hero")),this.updatePower(),c},removeRole:function(t){console.log("removeRole -------------------------",this.heroList,this.enemyList);var e=this.enemyList;for(var i in 0==t.type&&(e=this.heroList),this.shake(),e)if(t==e[i]){e.splice(i,1),console.log("removeRole 1111111111",e.length,i);break}this.updatePower(),console.log("removeRole ssssssssss",e.length,e,t,t.type),e.length<=0&&this.gameState!=MyEnum.GameState.Over&&this.onBattleOver(0!=t.type)},shake:function(){this.fightP.parent.position=cc.Vec2.ZERO,cc.Tween.stopAllByTarget(this.fightP.parent),cc.tween(this.fightP.parent).by(.02,{position:cc.v2(5,3)}).by(.02,{position:cc.v2(-1,-2)}).by(.02,{position:cc.v2(-4,3)}).by(.02,{position:cc.v2(-2,-4)}).by(.02,{position:cc.v2(3,-2)}).by(.02,{position:cc.v2(-3,-3)}).by(.02,{position:cc.v2(4,4)}).by(.02,{position:cc.v2(-2,1)}).start()},updatePower:function(){var t=0;for(var e in this.heroList)t+=this.heroList[e].getPower();for(var i in this.sPowerLab.string=t,t=0,this.enemyList)t+=this.enemyList[i].getPower();this.oPowerLab.string=t},onBattleOver:function(){},backTOMenu:function(){Utils.switchScene("main")},startRecord:function(){console.log("RecordScreen","startRecord"),platformAdapter.startRecordScreen(300,function(t){console.log("RecordScreen","startRecord call",t),"error"==t?cc.director.emit("RecordScreenError",{}):"end"==t?cc.director.emit("RecordScreenEnd",{}):"start"==t&&cc.director.emit("RecordScreenStart",{})})}}),cc._RF.pop()},{PoolManager:void 0}],endlessGame:[function(t,e){"use strict";cc._RF.push(e,"385a063wtVO65mknoAMoyG2","endlessGame");var i=t("Comm"),a=t("PoolManager"),n=t("../../../load/common/GroupWait"),o=[cc.color(216,267,48),cc.color(74,122,251),cc.color(230,211,79),cc.color(254,0,214),cc.color(17,240,80)],r=[cc.v2(0,-25),cc.v2(0,-25),cc.v2(0,-40),cc.v2(0,-40),cc.v2(0,-35)];cc.Class({extends:cc.Component,properties:{starPrefab:cc.Prefab,starGrid:cc.Node,heroPres:[cc.Prefab],fightP:cc.Node,bgN:cc.Node,bars:[cc.Node],eliminateEffectPrefab:cc.Prefab,mats:[cc.Material],txtStep:cc.Label,newHeroPre:cc.Prefab,missionLab:cc.Label,overPanel:t("basePanel"),lightAPre:cc.Prefab,gjSf:cc.SpriteFrame,readyBattleN:cc.Node,sPowerLab:cc.Label,oPowerLab:cc.Label,panelParent:cc.Node,bgBgN:cc.Node,bgs:{default:[],type:cc.SpriteFrame}},onLoad:function(){},start:function(){var t,e,n=this;for(var o in this.starGrid.on(cc.Node.EventType.TOUCH_END,function(t){var e=n.starGrid.convertToNodeSpace(t.touch.getLocation());n.touchStar(parseInt(e.x/(n.starGrid.width/i.gridWidth)),parseInt(e.y/(n.starGrid.height/i.gridHeight)))}),this.heroPres)a.initPoolByName("hero"+o,this.heroPres[o],0);a.initPoolByName("eliEffect",this.eliminateEffectPrefab,5),a.initPoolByName("newHero",this.newHeroPre,3),a.initPoolByName("lightAPre",this.lightAPre,3),a.initPoolByName("starPrefab",this.starPrefab,0),cc.director.getCollisionManager().enabled=!0,this.initNextStep(),this.heroList=[],this.overPanel.node.active=!1,this.leftStep=Number(this.misCfg.stepNum),(null==(t=playerInfo.tempAttr)?void 0:t.clean_num)&&(this.leftStep+=null==(e=playerInfo.tempAttr)?void 0:e.clean_num);var r=playerInfo.getAdditive("clean_num");for(r&&(this.leftStep+=r),this.updateCurStep(),this.xMaxOffset=625,this.xSpringBackOffset=125,this.proList=[0,0,0,0,0],this.typeList=[0,0,0,0,0],this.scaleList=[],o=0;o<5;o++)this.scaleList[o]=this.bars[o].getChildByName("icon1").scale;this.initUI(),this.starGame(),Global.gameCtrl=this},initNextStep:function(){var t;this.level=this.level||0,this.level++;var e=this.level+5*(this.level-1);this.misCfg=null!=(t=Config.mission[e-1])?t:Config.mission[Config.mission.length-1],this.missionLab.string="\u7b2c"+this.level+"\u5173";var i=this.misCfg.enemy_list.split(",");for(var a in i)""==i[a]?i[a]=0:i[a]=Number(i[a]);this.enemy_list=i,this.enemyList=[],this.initEnemy()},initUI:function(){for(var t in this.addStep=5,this.readyBattleN.active=!1,this.bars)this.bars[t].getComponent(cc.ProgressBar).progress=.01},getRandomType:function(){if(!this.weight_list){var t=[1,1,1,1];for(var e in this.weight_list=[],t){var i=t[e]*playerInfo.getRandomBoxRate(Number(e)+1);e>0&&(i+=this.weight_list[e-1]),this.weight_list.push(i)}}var a=this.weight_list[this.weight_list.length-1],n=Math.random()*a;for(var o in this.weight_list)if(n<this.weight_list[o])return Number(o)+1},updateCurStep:function(){this.txtStep.string=this.leftStep,this.leftStep<=0?this.txtStep.node.parent.active=!1:this.txtStep.node.parent.active=!0},starGame:function(){this.initStatus(),this.initGrid(),i.calcTargetStr(),this.gameState=MyEnum.GameState.Clear},initStatus:function(){this.stVar={},this.stVar.selected=!1,this.totalScore=0},initGrid:function(){if(this.gridStarUi)for(var t=0;t<i.gridWidth;t++)for(var e=0;e<i.gridHeight;e++)this.gridStarUi[t][e]&&this.gridStarUi[t][e].destroy();for(var a=[],n=[],o=0;o<i.gridWidth;o++){a[o]=[],n[o]=[];for(var r=0;r<i.gridHeight;r++)a[o][r]=0}this.gridData=a,this.gridStarUi=n,this.starGrid.width=80*i.gridWidth,this.starGrid.height=80*i.gridHeight,this.fallDownStar(!0,function(){})},touchStar:function(t,e){var i,a=this;this.touching||this.leftStep<=0||0!=this.gridData[t][e]&&(this.touching=!0,this.stVar.connectStars=[[t,e]],this.checkStar(t,e),this.stVar.connectStars.length>=2?(Utils.emitGuideEvent(MyEnum.GuideEvents.StartCleanStar),this.leftStep--,this.updateCurStep(),this.cleanGw=null!=(i=this.cleanGw)?i:new n(null),this.cleanOnce(t,e,function(){a.touching=!1}).then(function(){a.leftStep<=0&&a.cleanGw.isDone()&&a.readyBattle()})):this.touching=!1)},readyBattle:function(){this.readyBattleN.active=!0,this.addStep?this.gameState=MyEnum.GameState.Ready:this.startBattle()},startBattle:function(){this._startBattle()},_startBattle:function(){if(this.gameState!=MyEnum.GameState.Battle){for(var t in Global.audioCtrl.playWorldBgm(),this.gameState=MyEnum.GameState.Battle,cc.find("btn_start",this.readyBattleN).active=!1,cc.find("btn_add",this.readyBattleN).active=!1,this.bars)cc.tween(this.bars[t]).to(.3,{opacity:0}).start();var e=cc.find("bg",this.readyBattleN);console.log("this.starGrid",this.starGrid,e),cc.tween(this.bgBgN).to(.2,{height:780},{easing:"sineInOut"}).start(),cc.tween(e).to(.2,{height:780},{easing:"sineInOut"}).start()}},onClickedStartBtn:function(){this.startBattle()},onClickedAddStepBtn:function(){this.leftStep+=this.addStep,this.updateCurStep(),this.gameState=MyEnum.GameState.Clear,this.readyBattleN.active=!1,this.addStep=0},touchStart:function(t){this.selectInfo=null;var e=this.starGrid.convertToNodeSpace(t.touch.getLocation()),a=parseInt(e.x/(this.starGrid.width/i.gridWidth)),n=parseInt(e.y/(this.starGrid.height/i.gridHeight));console.log(e.x,a,n,"xxxxxxxx yyyyyyyyyy"),this.leftStep<=0||this.gridData[a]&&this.gridData[a][n]&&(this.selectInfo={list:[[a,n]],type:this.gridData[a][n]},this.addSelectAction(a,n))},addSelectAction:function(t,e){var i=this.gridStarUi[t][e];cc.tween(i).repeatForever(cc.tween().to(.2,{scale:1.05}).to(.2,{scale:1})).start()},clearSelectAction:function(t,e){var i=this.gridStarUi[t][e];cc.Tween.stopAllByTarget(i),i.scale=1},touchMove:function(t){if(console.log("=========touchMove===========safawd"),this.selectInfo){var e=this.starGrid.convertToNodeSpace(t.touch.getLocation()),a=parseInt(e.x/(this.starGrid.width/i.gridWidth)),n=parseInt(e.y/(this.starGrid.height/i.gridHeight));if(this.gridData[a]&&this.gridData[a][n]){var o=this.gridData[a][n];if(console.log("=========touchMove==========="),o==this.selectInfo.type){var r=this.selectInfo.list[this.selectInfo.list.length-1];if(this.selectInfo.list.length>1){var s=this.selectInfo.list[this.selectInfo.list.length-2];if(s[0]==a&&s[1]==n){var c=this.selectInfo.list.pop();return console.log(c,r,"aaaaaaaaaaaa"),void this.clearSelectAction(c[0],c[1])}}if(Math.abs(a-r[0])>1||Math.abs(n-r[1])>1)console.log("=========touchMove=========== 2",a,n,r);else{for(var l in this.selectInfo.list)if(a==this.selectInfo.list[l][0]&&n==this.selectInfo.list[l][1])return void console.log("=========touchMove=========== 3");this.selectInfo.list.push([a,n]),this.addSelectAction(a,n)}}else console.log("=========touchMove=========== 1",o,this.selectInfo.type)}}},touchEnd:function(){var t=this;if(this.selectInfo){for(var e in this.selectInfo.list)this.clearSelectAction(this.selectInfo.list[e][0],this.selectInfo.list[e][1]);this.selectInfo.list.length<2||(this.leftStep--,this.updateCurStep(),this.clearConnect(this.selectInfo.type,function(){}).then(function(){t.leftStep<=0&&(t.gameState=MyEnum.GameState.Ready)}))}},clearConnect:function(t){var e=this;return new Promise(function(i){for(var o=new n(function(){e.fallDownStar()}),r=new n(function(){i()}),s=.1*(e.selectInfo.list.length-2)+1,c=function(){var i=e.selectInfo.list[l],n=e.gridStarUi[i[0]][i[1]];r.wait(),e.playElmEffect(n,e.gridData[i[0]][i[1]]-1,function(){e.addProgress(t,s,function(){r.done()})}),o.wait(),cc.tween(n).to(.1,{scale:1.1}).to(.1,{scale:1}).by(.3,{angle:360,scale:-1,opacity:-250}).call(function(){a.pushPoolNodeByName("starPrefab",n),e.gridData[i[0]][i[1]]=0,console.log("11111111111"),o.done()}).start()},l=e.selectInfo.list.length-1;l>=0;l--)c()})},checkStar:function(t,e){this.stVar.connectStars=this.checkStarNew(t,e)},getMaxConnect:function(){for(var t={},e=[],a=0;a<i.gridWidth;a++)for(var n=0;n<i.gridHeight;n++){var o=this.checkStarNew(a,n,t);o.length>=2&&e.push(o)}var r=[];for(var s in e)e[s].length>r.length&&(r=e[s]);return r},getGuideClickNodes:function(){var t=this.getMaxConnect(),e=[];for(var i in t){var a=t[i],n=this.gridStarUi[a[0]][a[1]];e.push(n)}return e},checkStarNew:function(t,e,i){var a;i=null!=(a=i)?a:{};for(var n=this.gridData[t][e],o=[],r=[[t,e]];r.length>0;){var s=r.shift(),c=s[0]+"_"+s[1];i[c]||this.inGrid(s[0],s[1])&&this.gridData[s[0]][s[1]]==n&&(o.push(s),i[c]=!0,r.push([s[0]+1,s[1]]),r.push([s[0]-1,s[1]]),r.push([s[0],s[1]-1]),r.push([s[0],s[1]+1]))}return o},inGrid:function(t,e){return t>=0&&t<i.gridWidth&&e>=0&&e<i.gridHeight},connectContain:function(t,e){for(var i=this.stVar.connectStars.length-1;i>=0;i--){var a=this.stVar.connectStars[i];if(a[0]==t&&a[1]==e)return!0}return!1},setConnectStarSelect:function(t){for(var e=this.stVar.connectStars.length-1;e>=0;e--){var i=this.stVar.connectStars[e];this.gridStarUi[i[0]][i[1]].getComponent("StarPrefab").setSelected(t)}this.stVar.selected=t},cleanOnce:function(t,e,i){var a=this;return new Promise(function(n){var o=a.gridStarUi[t][e].getComponent("StarPrefab").starType;a.stVar.connectStars.length,a.cleanGw.wait(),a.clearConnectStar(o,function(){a.cleanGw.done(),n()}).then(function(){a.fallDownStar(!1,i)})})},viewMoveToPos:function(t){var e=t.x,i=this.xMaxOffset-this.xSpringBackOffset;e>i?e=i:e<-i&&(e=-i);var a=-e;Math.abs(this.bgN.x-a),this.bgN.x=cc.misc.lerp(this.bgN.x,a,.05)},autoFollowFirstHumanRole:function(){if(!(this.heroList.length<=0)){var t=-3e3;this.heroList.forEach(function(e){e.node.x>t&&(t=e.node.x)}),t>Math.abs(this.bgN.x)&&(this.bgN.x=-t),console.log(this.bgN.x,t,this.heroList,"autoFollowFirstHumanRole")}},addProgress:function(t,e,i){var a=this,o=this.bars[t-1].getComponent(cc.ProgressBar),r=.2*playerInfo.getExpendRate(t),s=this.proList[t-1]+r*e;this.proList[t-1]=s;var c=this.bars[t-1].getChildByName("icon1").getComponent(cc.Sprite),l=this.bars[t-1].getChildByName("light1"),h=new n(i,1);if(s>=1){for(var d=0;s>=1;)s=Math.max(s-1,.01),this.proList[t-1]=s,h.wait(),this.scheduleOnce(function(){var e;e=function(){h.done()},o.progress=1,c.setMaterial(0,a.mats[1]),l.active=!0,cc.tween(c.node).to(.12,{scale:1.5*a.scaleList[t-1]}).to(.09,{scale:a.scaleList[t-1]}).call(function(){l.active=!1,c.setMaterial(0,a.mats[0]),a.addHero(t,e),c.node.scale=a.scaleList[t-1],c.node.opacity=255,o.progress=a.proList[t-1]}).start()},.2*d),d++;h.done()}else o.progress=s,h.done()},initEnemy:function(){var t=this,e=this.misCfg.monster.split("|"),i=[];for(var a in e){var n=e[a].split(",");i.push(n)}console.log("enemy_list",i);var o=0,r={},s=function(e){var a=i[e],n=Number(a[0]),s=Number(a[1]),c=Number(a[2])||1,l=Number(a[3])||1,h=Config.monster[n],d=Config.strength[s+""+c],f=Number(h.modelID),u=Config.skin[f-1],g=Number(u.e_id);r[g]||(r[g]=0);for(var p=0;p<l;p++)o++,t.scheduleOnce(function(){t.addEnemy(f,c,r[g],Number(h.modelsize),d),r[g]++},.1*o)};for(var c in i)s(c)},fun:function(t,e){return 1==t?e:2==t?e-1:2*this.fun(t-1,e)},getRoleY:function(t,e,i){void 0===i&&(i=4);for(var a=1,n=0,o=t;!((n=this.fun(a,i))>o);)a++,o-=n;return 1==a?e/(i-1)*o:e/n*(o+.5)},addHero:function(t,e){var i=a.getPoolNodeByName("hero"+(t-1));i.parent=this.fightP,i.position=this.fightP.convertToNodeSpaceAR(this.bars[t-1].convertToWorldSpaceAR(cc.Vec2.ZERO)),i.getChildByName("barBlood").active=!1;var n=this.typeList[t-1],o=25;4==t?o=100:1==t&&(o=0);var r=o+this.getRoleY(n,50,4),s=cc.v2(this.getPosX(t-1,-150-20*Math.random(),!0),r),c=playerInfo.getAdditive(t),l=playerInfo.ELevels[t-1],h=playerInfo.getAddLevel(t);l+=h,console.log("lv ****",h);var d={cfg:{type:t},level:l,attr:Utils.getStudentInfo({id:t,eLevel:l},c),skinId:playerInfo.CurSkin[t-1]};i.getComponent("hero").updateInfo(this,d,0);var f=s,u=cc.v2(2*f.x/3+i.x/3,f.y+(f.y-i.y)/20+100);cc.tween(i).set({scale:.8*i.scale}).parallel(cc.tween().bezierTo(.5,u,u,f),cc.tween().to(.5,{scale:i.scale},{easing:"backOut"})).call(function(){i.zIndex=-s.y,i.getChildByName("barBlood").active=!0,e&&e()}).start(),this.typeList[t-1]++,this.heroList.push(i.getComponent("hero")),this.updatePower()},_addHero:function(t,e){var i=this,n=a.getPoolNodeByName("newHero");n.parent=this.bars[t-1],n.position=cc.v2(0,0),n.getComponent("newHero").updateType(t-1);var o=a.getPoolNodeByName("hero"+(t-1));o.parent=n,o.position=r[t-1],o.getChildByName("barBlood").active=!1;var s=this.typeList[t-1],c=25;4==t&&(c=180);var l=c+20*(s%2==0?1:-1)*Math.ceil(Math.abs(s/2)),h=cc.v2(this.getPosX(t-1,0,!0)+40*Math.random()-20,l);h.x-=80;var d=this.fightP.convertToWorldSpaceAR(h),f=n.parent.convertToNodeSpaceAR(d),u=playerInfo.getAdditive(t),g=playerInfo.ELevels[t-1],p=Utils.getStudentInfo({id:t,eLevel:g},u);console.log("attr",p);var v={cfg:{type:t},attr:p};o.getComponent("hero").updateInfo(this,v,0);var m=f,b=cc.v2(2*m.x/3+n.x/3,m.y+(m.y-n.y)/4+100);console.log(n.position,b,m,"newHeroP.position, p1, pp"),cc.tween(n).bezierTo(.6,b,b,m,{easing:"sineOut"}).call(function(){o.parent=i.fightP,o.position=h,o.zIndex=-h.y,o.getChildByName("barBlood").active=!0,a.pushPoolNodeByName("newHero",n),e&&e()}).start(),this.typeList[t-1]++,this.heroList.push(o.getComponent("hero"))},addEnemy:function(t,e,i,n,o){console.log("scale ",n);var r=Config.skin[t-1];console.log(t,r,"addEnemy");var s=Number(r.e_id),c=a.getPoolNodeByName("hero"+(s-1));c.parent=this.fightP,c.x=this.getPosX(s-1,150+20*Math.random());var l=25;4==s?l=100:1==s&&(l=0),c.y=l+this.getRoleY(i,50,4);var h={cfg:{type:s},level:e,attr:Utils.getMonsterInfo(o),skinId:s};c.getComponent("hero").updateInfo(this,h,1,n),this.enemyList.push(c.getComponent("hero")),this.updatePower()},removeRole:function(t){console.log("removeRole -------------------------",this.heroList,this.enemyList);var e=this.enemyList;for(var i in 0==t.type&&(e=this.heroList),this.shake(),e)if(t==e[i]){e.splice(i,1),console.log("removeRole 1111111111",e.length,i);break}this.updatePower(),console.log("removeRole ssssssssss",e.length,e,t,t.type),e.length<=0&&this.gameState!=MyEnum.GameState.Over&&this.onBattleOver(0!=t.type)},updatePower:function(){var t=0;for(var e in this.heroList)t+=this.heroList[e].getPower();for(var i in this.sPowerLab.string=t,t=0,this.enemyList)t+=this.enemyList[i].getPower();this.oPowerLab.string=t},shake:function(){cc.tween(this.fightP.parent).by(.02,{position:cc.v2(5,3)}).by(.02,{position:cc.v2(-1,-2)}).by(.02,{position:cc.v2(-4,3)}).by(.02,{position:cc.v2(-2,-4)}).by(.02,{position:cc.v2(3,-2)}).by(.02,{position:cc.v2(-3,-3)}).by(.02,{position:cc.v2(4,4)}).by(.02,{position:cc.v2(-2,1)}).start()},onDestroy:function(){Global.audioCtrl.stopWorldBgm()},showMatchOverPanel:function(t){var e=this;Utils.loadBundle("game",function(i,a){a.load("panel/matchOverPanel/matchOverPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,n.getComponent("basePanel").show(t)})})},showTipPanel:function(t,e){var i=this;this.tipPanel?(this.tipPanel.node.active=!0,this.tipPanel.show(t,e)):(Global.openMask(),Utils.loadBundle("main_a",function(a,n){n.load("panel/tipPanel/tipPanel",cc.Prefab,function(a,n){var o=cc.instantiate(n);o.parent=i.panelParent,i.tipPanel=o.getComponent("basePanel"),i.tipPanel.show(t,e),Global.closeMask()})}))},openZhuXianBuffPanel:function(t){var e=this;Utils.loadBundle("main_a",function(i,a){a.load("panel/zhuxianbuffPanel/zhuxianbuffPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,n.getComponent("basePanel").show(t)})})},showChaojikaijuPanel:function(t){var e=this;Utils.loadBundle("main_a",function(i,a){a.load("panel/chaojikaijuPanel/chaojikaijuPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,n.getComponent("basePanel").show(t)})})},showEndlessSuccessPanel:function(t){var e=this;this.endlessSuccessPanel?(this.endlessSuccessPanel.node.active=!0,this.endlessSuccessPanel.show(t)):(Global.openMask(),Utils.loadBundle("main_a",function(i,a){a.load("panel/wujinvictoryPanel/wujinvictoryPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,e.endlessSuccessPanel=n.getComponent("basePanel"),e.endlessSuccessPanel.show(t),Global.closeMask()})}))},showEndlessOverPanel:function(t){var e=this;Utils.loadBundle("main_a",function(i,a){a.load("panel/wujinoverPanel/wujinoverPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,n.getComponent("basePanel").show(t)})})},onBattleOver:function(t){var e=this;this.gameState=MyEnum.GameState.Over,Global.audioCtrl.stopWorldBgm(),playerInfo.clearTempAttr(),t?Global.audioCtrl.playWinClip():Global.audioCtrl.playFailClip(),t?(this.gameState=MyEnum.GameState.Ready,this.initNextStep(),this.showEndlessSuccessPanel(function(t){console.log("result *****",t);var i=function(i){var a=t[i];e.heroList.forEach(function(t){t.addBuff(a)}),playerInfo.addTempAttr(a)};for(var a in t)i(a);e.gameState=MyEnum.GameState.Battle})):this.showEndlessOverPanel(this.level-1)},getPosX:function(t,e,i){var a;void 0===i&&(i=!1);var n=1;switch(i&&(n=-1),t){case 0:a=40;break;case 1:a=80;break;case 2:a=0;break;case 3:a=80;break;case 4:a=100}return e+a*n},backTOMenu:function(){console.log("backTOMenu"),Utils.switchScene("main")},clearConnectStar:function(t,e){var i=this;return new Promise(function(t){for(var o=new n(function(){t()}),r=new n(e,1),s=function(t){var e=i.stVar.connectStars[t],n=i.gridStarUi[e[0]][e[1]];n.getComponent("StarPrefab").setToLight(),n.zIndex=100,i.gridStarUi[e[0]][e[1]]=null,o.wait();var s=i.gridData[e[0]][e[1]];i.gridData[e[0]][e[1]]=0,r.wait(),cc.tween(n).delay(.1*Math.sqrt(t)).call(function(){i.playElmEffect(n,s-1,function(){i.addProgress(s,1,function(){r.done()})}),Global.audioCtrl.playHCAudio()}).to(.1,{scale:1.1}).to(.1,{scale:1}).parallel(cc.tween().by(.3,{angle:360,scale:-1,opacity:-250}),cc.tween().delay(.15).call(function(){o.done()})).call(function(){a.pushPoolNodeByName("starPrefab",n)}).start()},c=i.stVar.connectStars.length-1;c>=0;c--)s(c);r.done()})},fallDownStar:function(t,e){for(var a=new n(e,1),o=0;o<i.gridWidth;o++){for(var r=0,s=0;s<i.gridHeight;s++)0==this.gridData[o][s]&&r++,r>0&&this.gridData[o][s]>0&&(this.gridData[o][s-r]=this.gridData[o][s],this.gridData[o][s]=0,this.gridStarUi[o][s].getComponent("StarPrefab").goTo(o,s-r,0),this.gridStarUi[o][s-r]=this.gridStarUi[o][s],this.gridStarUi[o][s]=null);r>0&&(a.wait(),this.fillEmptyStar(o,r,t,function(){a.done()}))}a.done()},fillEmptyStar:function(t,e,o,r){for(var s=this,c=new n(r,1),l=function(n){var r=n;c.wait(),s.scheduleOnce(function(){var n=a.getPoolNodeByName("starPrefab"),l=n.getComponent("StarPrefab");n.parent=s.starGrid;var h=s.getRandomType();l.setType(h),o?(s.gridData[t][i.gridHeight+r-e]=h,s.gridStarUi[t][i.gridHeight+r-e]=n,l.setGridXY(t,i.gridHeight+r-e),c.done()):(s.gridData[t][i.gridHeight+r-e]=h,s.gridStarUi[t][i.gridHeight+r-e]=n,l.setGridXY(t,i.gridHeight),l.goTo(t,i.gridHeight+r-e,0,function(){c.done()}))},o?.05*r:.125*r)},h=0;h<e;h++)l(h);c.done()},fallLeftStar:function(){for(var t=0,e=0;e<i.gridWidth;e++)if(0==this.gridData[e][0]&&t++,0!=this.gridData[e][0]&&0!=t)for(var a=0;a<i.gridHeight&&this.gridData[e][a]>0;a++)this.gridData[e-t][a]=this.gridData[e][a],this.gridData[e][a]=0,this.gridStarUi[e][a].getComponent("StarPrefab").goTo(e-t,a,.1),this.gridStarUi[e-t][a]=this.gridStarUi[e][a],this.gridStarUi[e][a]=null},checkOver:function(){for(var t=0;t<i.gridWidth;t++)for(var e=0;e<i.gridHeight;e++){var a=this.gridData[t][e];if(0==a)break;for(var n=[[t+1,e],[t-1,e],[t,e-1],[t,e+1]],o=0;o<n.length;o++){var r=n[o][0],s=n[o][1];if(this.inGrid(r,s)&&this.gridData[r][s]==a)return!1}}return!0},checkCount:function(){for(var t=0,e=0;e<i.gridWidth;e++)for(var a=0;a<i.gridHeight;a++)this.gridData[e][a]>0&&t++;return t},targetButtonClick:function(){var t;t=i.targetStrTab.oneTarget?"\u76ee\u6807:"+i.targetStrTab.oneTarget+"\u5206"+i.targetStrTab.oneTargetStr:"\u5c0f\u76ee\u6807:"+i.targetStrTab.littleTarget+"\u5206"+i.targetStrTab.littleTargetStr+"\n\u5927\u76ee\u6807:"+i.targetStrTab.bigTarget+"\u5206"+i.targetStrTab.bigTargetStr,console.log(t),i.confirm("\u76ee\u6807",t,"\u786e\u5b9a",function(){})},playElmEffect:function(t,e,i){for(var r=t.convertToWorldSpaceAR(cc.Vec2.ZERO),s=this.bars[e].convertToWorldSpaceAR(cc.v2(0,0)),c=new n(i),l=Math.floor(4*Math.random()+1),h=function(t){var i=a.getPoolNodeByName("eliEffect");i.active=!0,i.scale=2*Math.random()+.5,i.opacity=255,i.position=r,i.zIndex=999,i.parent=cc.director.getScene(),i.color=o[e];var n=cc.v2(s.x+40*Math.random()-20,s.y+40*Math.random()-20),h=r.add(cc.v2(0,30).rotate(2*Math.PI/l*t+Math.random()*Math.PI*2/l)),d=n.sub(h),f=[h.add(cc.v2(d.x/10,0)),n.add(cc.v2(0,-d.y/10)),n],u=.3*Math.random()+.4;c.wait(),i.runAction(cc.sequence(cc.moveTo(.1,h).easing(cc.easeSineOut()),cc.bezierTo(u,f).easing(cc.easeOut(1)),cc.callFunc(function(){a.pushPoolNodeByName("eliEffect",i),c.done()})))},d=0;d<l;++d)h(d)},update:function(){this.gameState==MyEnum.GameState.Battle&&this.autoFollowFirstHumanRole()}}),cc._RF.pop()},{"../../../load/common/GroupWait":void 0,Comm:"Comm",PoolManager:void 0,basePanel:void 0}],endlessnew:[function(t,e){"use strict";cc._RF.push(e,"eea79HANAxJR4/cKzTfdGl2","endlessnew"),t("PoolManager");cc.Class({extends:t("baseGame"),properties:{sPowerLab:cc.Label,oPowerLab:cc.Label,levelLab:cc.Label,attrShowList:t("attrShowList"),bgN:cc.Node,talkLab:cc.Label},onLoad:function(){cc.director.getCollisionManager().enabled=!0,this.allN=this.bgN.parent.parent},start:function(){this.initData(),this.initUI(),this.initMission(),this.readyStartBattle()},readyStartBattle:function(){var t=this;if(this.talkLab.node.parent.active=!0,cc.tween(this.talkLab.node.parent).set({scale:0}).delay(.2).to(.3,{scale:1},{easing:"backIn"}).start(),1==this.level){var e=playerInfo.getValueByKey("endless_talk_index")||0;console.log("vvvv",Config.talk),console.log("vvvv2",Config.talk[1]);var i=Config.talk[1],a=i[e];this.talkLab.string=a.desc,++e>i.length-1&&(e=0),playerInfo.setValueByKey("endless_talk_index",e)}else{var n=Config.talk[2][this.level-2];this.talkLab.string=n.desc}this.showEndlessSuccessPanel({level:this.level},function(e){t.scheduleOnce(function(){window.tt||platformAdapter.updateBannerAdState(!0)},.4),console.log("result ",e);var i=function(i){var a=e[i];if("addRole"==a.att_type){for(var n=0;n<a.value;++n){var o=[1,2,4,8];a.e_id;var r=1;for(var s in o)Number(a.e_id)==o[s]&&(r=Number(s)+1);t.addHero(r,null,!0)}playerInfo.addTempAttr(a)}else t.heroList.forEach(function(t){t.addBuff(a)}),playerInfo.addTempAttr(a)};for(var a in e)i(a);t.attrShowList.node.active=!0,t.attrShowList.updateList(),t.updatePower(),console.log("addTempAttr",playerInfo.tempAttr),t.talkLab.node.parent.active=!1,t.setMoveType(2)})},initData:function(){this.enemyList=[],this.heroList=[],this.typeList=[0,0,0,0,0],this.level=1,this.rate=.15*playerInfo.EndlessLevel-.05,this.lastM=0},initUI:function(){this.initHero()},initHero:function(){for(var t=0;t<4;++t)this.addHero(t+1,null,!0)},getM:function(t){return t<=0?20:Math.floor((3*MyEnum.EndlessMaxLv-1.5*t+2)*t/2)+15},initMission:function(){var t=this.getM(this.level),e=this.getM(this.level-1),i=Math.floor(Math.random()*(t-e))+e-15;console.log("initMission m",i),this.misCfg=Config.mission[i],this.initEnemy(this.rate),this.levelLab.string="\u7b2c"+this.level+"\u5c42"},onBattleOver:function(t){if(this.gameState=MyEnum.GameState.Over,Global.audioCtrl.stopWorldBgm(),t?Global.audioCtrl.playWinClip():Global.audioCtrl.playFailClip(),t){if(this.level++,this.level>MyEnum.EndlessMaxLv)return playerInfo.endlessLevelUp(),void this.showEndlessOverPanel(MyEnum.EndlessMaxLv);this.initMission(),this.readyStartBattle()}else this.showEndlessOverPanel(this.level-1)},showEndlessSuccessPanel:function(t,e){var i=this;this.attrShowList.node.active=!1,this.setMoveType(1),this.endlessSuccessPanel?(this.endlessSuccessPanel.node.active=!0,this.endlessSuccessPanel.show(t,e)):(Global.openMask(),Utils.loadBundle("main_a",function(a,n){n.load("panel/wujinvictoryPanel/wujinvictoryPanel",cc.Prefab,function(a,n){var o=cc.instantiate(n);o.parent=i.panelParent,i.endlessSuccessPanel=o.getComponent("basePanel"),i.endlessSuccessPanel.show(t,e),Global.closeMask()})}))},showEndlessOverPanel:function(t){var e=this;Utils.loadBundle("main_a",function(i,a){a.load("panel/wujinoverPanel/wujinoverPanel",cc.Prefab,function(i,a){var n=cc.instantiate(a);n.parent=e.panelParent,n.getComponent("basePanel").show(t)})})},setMoveType:function(t){if(this.moveType=t,1==this.moveType){for(var e in this.heroList)this.heroList[e].playAnim("walk");var i=null;for(var a in this.heroList)(null==i||this.heroList[a].node.x>i)&&(i=this.heroList[a].node.x);this.targetX=i+this.allN.x+100,console.log(i,this.allN.x,"vvvvvvvvv",this.targetX)}else if(2==this.moveType){var n=null;for(var o in this.enemyList)(null==n||this.enemyList[o].node.x<n)&&(n=this.enemyList[o].node.x);var r=null;for(var s in this.heroList)(null==r||this.heroList[s].node.x>r)&&(r=this.heroList[s].node.x);this.targetX=-(r+n)/2,this.gameState=MyEnum.GameState.Battle}},bgMove:function(t){var e=100;if(this.targetX>0){for(var i in this.heroList)this.heroList[i].node.x-=80*t;this.targetX-=80*t,e+=80}this.bgN.x-=e*t,this.bgN.x+this.allN.x<-320&&(this.bgN.x+=640)},allMove:function(){this.allN.x=cc.misc.lerp(this.allN.x,this.targetX,.015),this.bgN.x+this.allN.x<-320&&(this.bgN.x+=640),Math.abs(this.allN.x-this.targetX)<10&&this.setMoveType(0)},update:function(t){1==this.moveType?this.bgMove(t):2==this.moveType&&this.allMove(t)},addEnemy:function(){var t=this._super.apply(this,arguments);t.x=t.x-this.allN.x+500},addBoss:function(){var t=this._super.apply(this,arguments);t.x=t.x-this.allN.x+500,t.y+=50},addHero:function(t,e,i){var a=this._super(t,e,i);a.x=a.x-this.allN.x;var n=a.position;cc.tween(a).by(0,{x:-100,y:-100}).then(cc.jumpTo(.3,n.x,n.y,100,1)).start()}}),cc._RF.pop()},{PoolManager:void 0,attrShowList:"attrShowList",baseGame:"baseGame"}],matchOverPanel:[function(t,e){"use strict";cc._RF.push(e,"504c1wBFadKXKkrz8fOm+Zb","matchOverPanel"),cc.Class({extends:t("basePanel"),properties:{successN:cc.Node,failN:cc.Node,grade:t("grade")},show:function(t){this.successN.active=t,this.failN.active=!t,this.grade.setGrade(playerInfo.Grade),platformAdapter.aldSendEvent("\u754c\u9762\u5c55\u793a_\u5339\u914d\u6218\u6597\u7ed3\u675f\u754c\u9762",{desc:"\u754c\u9762\u5c55\u793a_\u5339\u914d\u6218\u6597\u7ed3\u675f\u754c\u9762",missionId:playerInfo.MissionID})},onClickedGetBtn:function(){playerInfo.Diamond+=12,this.onClickedLeaveBtn(),Utils.showHintText("diamond_2",12)},onClickedLeaveBtn:function(){Global.gotoPage=3,Utils.switchScene("main")},onClickedGetStarBtn:function(){playerInfo.Grade++,Utils.showHintText("add_star"),this.onClickedLeaveBtn()}}),cc._RF.pop()},{basePanel:void 0,grade:void 0}],meetingOverPanel:[function(t,e){"use strict";cc._RF.push(e,"0b455STEbxLrZSGoMU4EIvD","meetingOverPanel"),cc.Class({extends:t("basePanel"),properties:{successN:cc.Node,failN:cc.Node,oldLab:cc.Label,newLab:cc.Label},show:function(t,e,i){this.successN.active=t,this.failN.active=!t,this.oldLab.string=e,this.newLab.string=i},onClickedGetBtn:function(){playerInfo.Diamond+=12,this.onClickedLeaveBtn(),Utils.showHintText("diamond_2",12)},onClickedLeaveBtn:function(){Global.gotoPage=3,Utils.switchScene("main")}}),cc._RF.pop()},{basePanel:void 0}],newHero:[function(t,e){"use strict";cc._RF.push(e,"1ec90ib8B1LbYqGX6Zuzq/R","newHero"),cc.Class({extends:cc.Component,properties:{bars:[cc.SpriteFrame],lights:[cc.SpriteFrame],barSp:cc.Sprite,lightSp:cc.Sprite},updateType:function(t){this.node.stopAllActions(),this.barSp.spriteFrame=this.bars[t],this.lightSp.spriteFrame=this.lights[t],cc.tween(this.node).to(.25,{scaleX:.9,scaleY:1.1}).to(.25,{scaleX:1.1,scaleY:.9}).union().repeatForever().start()},start:function(){}}),cc._RF.pop()},{}],overPanel:[function(t,e){"use strict";cc._RF.push(e,"acccfx67uxL1qaECmq91X9U","overPanel"),cc.Class({extends:t("basePanel"),properties:{successN:cc.Node,failN:cc.Node,rewardLab:cc.Label,reward2Lab:cc.Label,btnN:cc.Node,btnRecord:cc.Node,doubleLabs:[cc.Label]},onLoad:function(){var t=this;this.btnRecord.active=!1,this.btnN.active=!0,console.log("RecordScreen","overpanel onload",platformAdapter.isRecordScreen()),platformAdapter.isRecordScreen()&&(console.log("RecordScreen","cc.director.on"),cc.director.on("RecordScreenError",function(){console.log("RecordScreen","RecordScreenError"),t.btnN.active=!0,t.btnRecord.active=!1}),cc.director.on("RecordScreenEnd",function(){Global.showOverFre=Global.showOverFre||0,console.log("RecordScreen","RecordScreenEnd",Global.showOverFre),Global.showOverFre%2==0||Global.gameType!=MyEnum.GameType.Normal?(console.log("RecordScreen","RecordScreenEnd0",t.btnN,t.btnRecord),t.btnN.active=!0,t.btnRecord.active=!1):(console.log("RecordScreen","RecordScreenEnd1",t.btnN,t.btnRecord),t.btnN.active=!1,t.btnRecord.active=!0)}))},onDestroy:function(){platformAdapter.isRecordScreen()&&(cc.director.off("RecordScreenError"),cc.director.off("RecordScreenEnd"))},show:function(t,e){for(var i in Global.showOverFre=Global.showOverFre||0,t?(Global.showOverFre++,Global.autoOpenBonus=!1):Global.autoOpenBonus=!0,this.successN.active=t,this.failN.active=!t,this.reward=Math.floor(Number(e.reward)*playerInfo.getCoinRate()),this.reward2=Number(e.reward2),this.rewardLab.string=this.reward,this.reward2>0?(this.reward2Lab.node.parent.active=!0,this.reward2Lab.string=this.reward2):this.reward2Lab.node.parent.active=!1,platformAdapter.stopRecordScreen(),this.doubleRate=5,Global.gameType==MyEnum.GameType.Boss&&(this.doubleRate=2),this.doubleLabs)this.doubleLabs[i].string=this.doubleRate+"\u500d\u9886\u53d6"},onClickedRewardBtn:function(){var t=this;Global.audioCtrl.playCoinClip(),2==playerInfo.MissionID&&(window.isShowMianHand=!0),this.coinAction(this.rewardLab.node.convertToWorldSpaceAR(cc.Vec2.ZERO),5,null,function(){playerInfo.Gold+=t.reward,playerInfo.Diamond+=t.reward2,Utils.switchScene("main")},cc.find("asset/gold/iconGold",this.node)),this.reward2>0&&this.coinAction(this.reward2Lab.node.convertToWorldSpaceAR(cc.Vec2.ZERO),5,null,function(){},cc.find("asset/diamond/iconGold",this.node))},onShareRecord:function(){var t=this;platformAdapter.shareRecordScreen(function(){t.onGetDoubleReward()})},onGetDoubleReward:function(){var t=this;Global.audioCtrl.playCoinClip(),2==playerInfo.MissionID&&(window.isShowMianHand=!0),this.coinAction(this.rewardLab.node.convertToWorldSpaceAR(cc.Vec2.ZERO),10,null,function(){playerInfo.Gold+=t.reward*t.doubleRate,playerInfo.Diamond+=t.reward2*t.doubleRate,Utils.switchScene("main")},cc.find("asset/gold/iconGold",this.node)),this.reward2>0&&this.coinAction(this.reward2Lab.node.convertToWorldSpaceAR(cc.Vec2.ZERO),10,null,function(){},cc.find("asset/diamond/iconGold",this.node))},coinAction:function(t,e,i,a,n){Global.openMask();for(var o=t,r=n.convertToWorldSpaceAR(cc.Vec2.ZERO),s=Math.random()*Math.PI-3*Math.PI/4,c=2*Math.PI/e,l=function(t){var l=cc.instantiate(n);l.parent=cc.director.getScene(),l.position=o,l.active=!0;var h=s+c*t,d=50*Math.random()+50,f=cc.v2(Math.cos(h),Math.sin(h)).mul(d),u=f.add(o),g=f.mul(2).add(o);l.runAction(cc.sequence(cc.moveTo(.15,u).easing(cc.easeSineOut()),cc.bezierTo(.2+.05*t,[u,g,r]).easing(cc.easeInOut(1)),cc.callFunc(function(){n.stopAllActions(),n.runAction(cc.sequence(cc.scaleTo(.05,1.4),cc.scaleTo(.1,1))),l.destroy(),Utils.invokeCallback(i),t==e-1&&(Utils.invokeCallback(a),Global.closeMask())})))},h=0;h<e;++h)l(h)},onClickedGotoHomeBtn:function(){Utils.switchScene("main")},onClickedGotoMainBtn:function(){var t=playerInfo.ELevels,e=!1;for(var i in t){var a=Number(i)+1,n=t[i];n>Config["student_"+a].length&&(n=Config["student_"+a].length);var o=Config["student_"+a][n-1],r=o.cost;1==Number(o.cost_type)?(r=Math.floor(r*playerInfo.getLevelUpCoinRate()),playerInfo.Gold>=r&&(e=!0)):playerInfo.Diamond>=r&&(e=!0)}Global.gotoPage=e?1:Math.random()<.6?1:3,Utils.switchScene("main")},onClickedGotoGenieBtn:function(){Global.gotoPage=3,Utils.switchScene("main")}}),cc._RF.pop()},{basePanel:void 0}],showAds:[function(t,e){"use strict";cc._RF.push(e,"fcb39R0PjlNnoVNOWmqR2pi","showAds"),cc.Class({extends:cc.Component,properties:{},onEnable:function(){platformAdapter.updateBannerAdState(!0)},onDisable:function(){platformAdapter.updateBannerAdState(!1)},start:function(){}}),cc._RF.pop()},{}],station:[function(t,e){"use strict";cc._RF.push(e,"ff401MkDwtCEr4WlnI/SaWk","station"),cc.Class({extends:t("baseMan"),properties:{},updateInfo:function(t,e,i){void 0===i&&(i=0),this.isDead=!1,this.mgr=t,this.type=i,this.blood=2e3,this.initBlood=this.blood,this.attak=30,this.attackCDTime=2e3},onDie:function(){var t=this;this.attackRoleList=[],this.scheduleOnce(function(){t.attackTargetRole=null},.5)},playAtkAnim:function(){console.log("station atk....."),this.atkOver()},atkOver:function(){if(this.attackTargetRole){var t=this.attak;if(this.attackTargetRole.decHp(t)){var e=this.attackTargetRole.getComponent(cc.Animation);e&&(e.stop("hero2"),e.setCurrentTime(0,"heroOver2"),e.play("heroOver2")),this.attackTargetRole.onDie()}}}}),cc._RF.pop()},{baseMan:void 0}]},{},["matchOverPanel","meetingOverPanel","Comm","attrShowList","baseGame","endlessnew","ConfirmDialogPrefab","StarPrefab","TipPrefab","newHero","overPanel","station","GameScene","endlessGame","showAds"]);